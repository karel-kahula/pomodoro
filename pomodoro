#!/bin/bash
set -e

PIDFile=/tmp/pomodoro.pid
doBeginPomo=false
doWindPomo=false
interval=1500
pomoFile=/tmp/pomodoro
scriptName=$(basename $0)
winderTicks=12

cleanUp() {
    if [ -e $pomoFile ]; then
        rm $pomoFile
    fi
    if [ -e $PIDFile ]; then
      rm $PIDFile
    fi
}

endPomo() {
    displayNotification || true
    cleanUp
}

displayNotification() {
    terminal-notifier -title "üçÖ Pomodoro" -message "Time is up!" -sound default
}

initPomo() {
    beginTime=$(date '+%H:%M')
    
    # Try different date command formats
    if endTime=$(date -v +${interval}S '+%H:%M' 2>/dev/null); then
        : # BSD date 
    elif endTime=$(date --date="+${interval} seconds" '+%H:%M' 2>/dev/null); then
        : # GNU date 
    else
        echo "Error: Unable to calculate end time" >&2
        exit 1
    fi
    
    {
      sleep $interval
      endPomo
    } &
    echo $! > "$PIDFile"
    echo "$beginTime -> $endTime" > "$pomoFile"
}

stopPomo() {
    if [ -e $PIDFile ]; then
        pomoPID=$(cat $PIDFile)
        checkPID=$(pgrep -f "$scriptName") || true
        if (echo "$checkPID" | fgrep --silent --word-regexp "$pomoPID"); then
            kill -TERM $pomoPID
        fi
        rm $PIDFile
    fi
    cleanUp
}

reportPomo() {
    if [ -e "$pomoFile" ]; then
        local timeInfo=$(cat "$pomoFile")
        local startTime=$(echo "$timeInfo" | cut -d' ' -f1)
        local endTime=$(echo "$timeInfo" | cut -d' ' -f3)
        echo "üçÖ Pomodoro Session"
        echo "Time now:    $(date '+%H:%M')"
        echo "Started at:  $startTime"
        echo "Ends at:     $endTime"
    else
        echo "No active Pomodoro session"
        exit 1
    fi
}

windPomo() {
    if pomoIsRunning; then
      return 1
    fi
    inputCount=0
    local bar_size=$winderTicks
    
    # Hide the cursor
    printf "\e[?25l"
    
    printf "Wind-up the timer: [%-${bar_size}s]" ""

    while [ "$inputCount" -lt "$bar_size" ]; do
        if read -s -n 1; then
            ((inputCount++))
            
            local hashes=""
            for ((i=0; i<inputCount; i++)); do hashes+="#"; done
            
            printf "\rWind-up the timer: [%-${bar_size}s]" "$hashes"
        fi
    done

    # Restore cursor and move to next line
    printf "\e[?25h\n"
}

printHelp() {
    echo "$scriptName - üçÖ - It's a 25 minute kitchen timer"
    echo
    echo "usage:"
    echo "$scriptName COMMAND"
    echo
    echo "commands:"
    echo "h, -h, --help"
    echo "      Show this help message"
    echo "b, begin"
    echo "      Begin the Pomodoro timer"
    echo "e, end"
    echo "      End the Pomodoro timer"
    echo "w, wind"
    echo "      Begin the Pomodoro by winding it up (mash some keys)"
    echo "s, status"
    echo "      Show current Pomodoro session start and end times"
    echo "a, alternate"
    echo "      Use the pomodoro alternate/break time (5 minutes)"
    echo "l, long"
    echo "      Use the pomodoro long break time (15 minutes)"
}

pomoIsRunning() {
  if [ -e $PIDFile ]; then
    echo "a pomodoro is already running!"
    reportPomo
    return 0
  fi

  return 1
}

beginPomo() {
    if pomoIsRunning; then
      return 1
    else
      stopPomo
      initPomo
      reportPomo
    fi
}

setInterval() {
    numberRe='^[0-9.]+$'
    if [[ -n "$1" && "$1" =~  $numberRe ]]; then
      interval=$(awk "BEGIN {print int($1 * 60)}")
    else
        printHelp
        exit 1
    fi
}

while test $# -gt 0; do
    case "$1" in
    h|help|-h|--help)
        printHelp
        exit 0
    ;;
    b|begin)
        doBeginPomo=true
        shift
    ;;
    s|status)
        reportPomo
        exit 0
    ;;
    e|end)
        stopPomo
        exit 0
    ;;
    w|wind)
        doWindPomo=true
        doBeginPomo=true
        shift
    ;;
    a|alternate)
        doBeginPomo=true
        setInterval '5'
        shift
    ;;
    l|long)
        doBeginPomo=true
        setInterval '15'
        shift
    ;;
    -t|--time)
        shift
        setInterval "$1"
        shift
    ;;
    *)
        break
    ;;
    esac
done

if [ "$doWindPomo" = true ]; then
    windPomo
fi

if [ "$doBeginPomo" = true ]; then
    beginPomo
    exit 0
fi

printHelp
exit 1
